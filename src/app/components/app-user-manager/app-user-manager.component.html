<app-app-user-manager-popup *ngIf="modePopup !== 'CLOSED'"
  [appUserId]="modePopup === 'ACTUALIZAR' ? appUserSelected?.id ?? 0 : 0" (cerrarPopUpOk)="onClosePopupOk()"
  (cerrarPopUpCancel)="onClosePopupCancel()"></app-app-user-manager-popup>

<div class="table-container">

  <div class="header-bar">
    <h2>Lista de Usuarios</h2>
    <button (click)="createAppUser()">+</button>
  </div>
  <!-- Search -->
  <div class="search-container">
    <label for="searchInput" class="search-label">Buscar:</label>
    <input id="searchInput" type="text" [(ngModel)]="searchValue" (input)="fetchFilteredUsers()"
      placeholder="Buscar el usuario..." />
    <button *ngIf="searchValue" (click)="clearSearch(); fetchFilteredUsers()" class="clear-button"
      title="Limpiar bÃºsqueda">
      âœ•
    </button>
    <select [(ngModel)]="searchType" (change)="fetchFilteredUsers()">
      <option value="name">Nombre</option>
      <option value="email">Email</option>
      <option value="id">ID</option>
    </select>
  </div>
  <div class="separator"></div>
  <div *ngIf="isLoading">Cargando...</div>

  <table class="task-table" *ngIf="!isLoading">
    <thead>
      <tr>
        <th (click)="onSort('id')" style="cursor: pointer;">
          ID
          <span *ngIf="sortColumn === 'id'">({{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }})</span>
        </th>
        <th (click)="onSort('name')" style="cursor: pointer;">
          Nombre
          <span *ngIf="sortColumn === 'name'">({{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }})</span>
        </th>
        <th (click)="onSort('email')" style="cursor: pointer;">
          Email
          <span *ngIf="sortColumn === 'email'">({{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }})</span>
        </th>
        <!-- <th>ContraseÃ±a</th> -->
        <th>Role</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <tbody *ngIf="displayedUsers.length > 0; else noResults">
      <tr *ngFor="let user of displayedUsers; trackBy: trackByUserId" (click)="appUserSelected = user"
        [class.selected]="user.id === appUserSelected?.id">
        <td>{{ user.id }}</td>
        <td>{{ user.name }}</td>
        <td>{{ user.email || '-' }}</td>
      <!--   <td [title]="user.password">
          {{ isPasswordHashed(user.password) ? '*encrypted*' : user.password || '-' }}
        </td> -->
        <td> 
          {{ user.role ? user.role.name : '-' }}
        </td>
        <td>
          <div class="action-buttons">
            <button (click)="appUserSelected = user; updateAppUser()" title="Editar">
              <i class="fas fa-pen"></i>
            </button>
            <button (click)="deleteAppUserById(user)" title="Eliminar">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
<!-- User Card View (mobile-friendly) -->
<div class="task-card-view">
  <div
    class="task-card"
    *ngFor="let user of displayedUsers"
    (click)="appUserSelected = user"
  >
    <h3>{{ user.name }}</h3>
    <p><strong>ID:</strong> {{ user.id }}</p>
    <p><strong>Email:</strong> {{ user.email || 'â€”' }}</p>
    <p><strong>Role:</strong> {{ user.role?.name || 'â€”' }}</p>
  </div>

  <!-- Actions Modal Overlay -->
  <div
    class="modal-overlay"
    *ngIf="modePopup === 'ACTUALIZAR' && appUserSelected"
    (click)="onClosePopupCancel()"
  ></div>

  <!-- Actions Modal Box -->
  <div
    class="modal-box"
    *ngIf="modePopup === 'ACTUALIZAR' && appUserSelected"
  >
    <h3>{{ appUserSelected.name }}</h3>
    <p><strong>ID:</strong> {{ appUserSelected.id }}</p>
    <p><strong>Email:</strong> {{ appUserSelected.email }}</p>
    <p><strong>Role:</strong> {{ appUserSelected.role?.name }}</p>

    <div class="modal-actions">
      <button (click)="updateAppUser()">âœ Editar</button>
      <button (click)="deleteAppUserById(appUserSelected)">ğŸ—‘ Eliminar</button>
      <button class="close" (click)="onClosePopupCancel()">Cerrar</button>
    </div>
  </div>
</div>



</div>

<ng-template #noResults>
  <tr>
    <td colspan="6" style="text-align: center; padding: 1rem;">
      No se encontraron usuarios.
    </td>
  </tr>
</ng-template>